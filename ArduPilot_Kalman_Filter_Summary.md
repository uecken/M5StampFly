# ArduPilot Kalman Filter 実装調査

このドキュメントは、ArduPilotにおけるカルマンフィルタの実装詳細についての調査結果をまとめたものである。

## カルマンフィルタの種類

ArduPilotでは、主に以下の種類のカルマンフィルタが実装されている：

1. **Extended Kalman Filter (EKF)** - 主なナビゲーションフィルタ
   - **EKF2** - AP_NavEKF2ライブラリに実装
   - **EKF3** - AP_NavEKF3ライブラリに実装（より新しいバージョン）
   
2. **EKFGSF (Extended Kalman Filter Gaussian Sum Filter)** - 主に方位角（ヨー）推定に使用
   - 複数のEKFモデルの出力を確率的に重み付けして組み合わせる
   - GPSを使用した速度ベースのヨー推定に使用

3. **特殊用途のEKF実装**
   - **SoloGimbalEKF** - Soloジンバルの安定化用
   - **AC_PrecLand** - 精密着陸用のKalmanフィルタ
   - **AP_Soaring** - ソアリング（滑空）用の拡張カルマンフィルタ

## 更新レート

フィルタの更新レートに関する詳細情報：

| フィルタ/機能 | 更新レート | 備考 |
|-------------|------------|------|
| EKF2/EKF3 メイン実行レート | 100Hz (10ms) | `EKF_TARGET_DT` は 0.01秒または 0.012秒（EKF3）に定義 |
| EKF2 | 100Hz (10ms) | EKF_TARGET_DT = 0.01秒と定義 |
| EKF3 | 83.3Hz (12ms) | EKF_TARGET_DT_MS = 12と定義（EKF_TARGET_DT = 0.012秒） |
| IMUデータローパスフィルタ | 10Hz カットオフ | `const float cutoff_hz = 10.0f;` によるローパスフィルタ |
| IMUサンプリングレート | 1kHz以上 | センサーに依存、最大8kHz |
| EKFへのIMUデータ提供 | 100Hz | オーバーサンプリングとダウンサンプリングを使用 |
| 姿勢・位置予測 | IMUサンプリングレート | イベントドリブン（新しいIMUデータが利用可能になるたびに実行） |
| EKFGSF | EKFメインループと同期 | 方位角推定用の補助フィルタ |

### IMUサンプリングとEKF更新

* IMUセンサーは非常に高いレート（最大8kHz）でサンプリングされるが、これはセンサーの種類に依存する
* IMUデータは「コーニングエラー」や「スカリングエラー」を避けるために特別な方法でダウンサンプリングされる
* EKFへのIMUデータ供給は約100Hz（EKF2）または約83.3Hz（EKF3）に調整される
* IMUのローパスフィルタは10Hzのカットオフ周波数を持ち、これはハイパスフィルタではなくローパスフィルタである

### サンプリング時間の管理

IMUの積分と正確なサンプリング時間の管理には、以下の技術が使われている：

```cpp
// コード例（AP_NavEKF3_Measurements.cpp より）
// IMU更新レートの平均を計算（スパイクとローパスフィルタの組み合わせを使用）
dtIMUavg = 0.02f * constrain_ftype(ins.get_loop_delta_t(), 0.5f * dtIMUavg, 2.0f * dtIMUavg) + 0.98f * dtIMUavg;

// EKFの平均時間ステップレートを計算
ftype dtNow = constrain_ftype(0.5f*(imuDataDownSampledNew.delAngDT+imuDataDownSampledNew.delVelDT), 0.5f * dtEkfAvg, 2.0f * dtEkfAvg);
dtEkfAvg = 0.98f * dtEkfAvg + 0.02f * dtNow;
```

IMUの積分時間（delta time）が非常に重要なため、以下の方法で管理されている：

1. **時間の測定**: 各IMUサンプル間の時間差（delAngDT, delVelDT）を直接測定
2. **制約付きフィルタリング**: 測定された時間差に制約をかけてフィルタリング
3. **バッファリング**: IMUデータをFIFOバッファに保存し、正確な時間順に処理
4. **最小dt保護**: ゼロまたは極小のdtを防ぐための保護
   ```cpp
   // dt値がゼロにならないよう保護
   ftype minDT = 0.1f*dtEkfAvg;
   imuDataDelayed.delAngDT = MAX(imuDataDelayed.delAngDT, minDT);
   imuDataDelayed.delVelDT = MAX(imuDataDelayed.delVelDT, minDT);
   ```

5. **四元数積算**: コーニングエラーを防ぐために四元数を使用した角度積算
   ```cpp
   // 四元数態度を前回から新しい値へ回転させて正規化
   // 四元数を使った蓄積によりダウンサンプリングによるコーニングエラーを防止
   imuQuatDownSampleNew.rotate(imuDataNew.delAng);
   imuQuatDownSampleNew.normalize();
   ```

## 利用センサ

ArduPilotのEKFは以下のセンサデータを利用する：

| センサ | 用途 | 関連する状態変数 | サンプリングレート |
|-------|------|----------------|------------------|
| IMU (ジャイロ) | 角速度、姿勢推定 | 角度誤差、デルタ角バイアス | 1kHz～8kHz（センサーによる） |
| IMU (加速度計) | 速度、位置推定 | 速度、デルタ速度バイアス | 1kHz～8kHz（センサーによる） |
| GPS | 位置、速度 | 水平位置、垂直位置、水平速度、垂直速度 | 5Hz～10Hz（一般的） |
| 気圧計 | 高度 | 垂直位置 | 50Hz程度 |
| 磁力計 (コンパス) | 方位角 | 地球磁場、機体磁場 | 100Hz程度 |
| 対気速度センサ | 風速推定 | 風速 | 50Hz程度 |
| 光学フロー | 地表に対する動き | 位置、速度補正 | 各センサーによる |
| レンジファインダ | 高度、障害物検知 | 垂直位置補正 | 各センサーによる |

## カルマンフィルタの状態変数

### EKF3の状態変数（24次元状態ベクトル）：

| インデックス | 状態変数 | 説明 |
|------------|---------|------|
| 0-3 | 四元数 | 姿勢表現 |
| 4-6 | 速度 | NED座標系での速度 |
| 7-9 | 位置 | NED座標系での位置 |
| 10-12 | ジャイロバイアス | デルタ角バイアス |
| 13-15 | 加速度バイアス | デルタ速度バイアス |
| 16-18 | 地球磁場 | 地球磁場ベクトル |
| 19-21 | 機体磁場 | 機体磁場ベクトル |
| 22-23 | 風速 | 風速ベクトル |

### EKFGSFの状態変数（3次元状態ベクトル × N_MODELS_EKFGSF）：

複数のモデル（通常は5つ）を同時に実行し、それらの出力を確率的に組み合わせることで、方位角（ヨー）の推定精度を向上：

```cpp
// EKFGSF構造体
struct GSF_struct {
    ftype yaw;                      // ヨー角（ラジアン）
    ftype yaw_variance;             // ヨー状態の分散（ラジアン^2）
    ftype weights[N_MODELS_EKFGSF]; // 各EKFモデルに適用される重み（合計1）
};
```

## フィルタの動作プロセス

1. **初期化（CovarianceInit）**：
   - 共分散行列の初期化
   - 状態ベクトルの初期値設定

2. **予測ステップ（Predict / UpdateStrapdownEquationsNED）**：
   - IMUデータを使用して状態を予測
   - デルタ角度・デルタ速度の補正と適用
   - 共分散行列の予測更新

3. **更新ステップ（各種センサデータのFusion）**：
   - GPS、気圧計、磁力計などのセンサデータを使用
   - イノベーション（測定値と予測値の差）の計算
   - カルマンゲインの計算と状態の更新
   - 共分散行列の更新

## 特徴と最適化

1. **数値的最適化**：
   - 直接観測される状態のための計算最適化
   - 対称行列の利用による計算量削減

2. **マルチレート処理**：
   - 高速なIMUデータと低速なGPSデータの異なるレートの処理
   - 遅延補償によるセンサデータの時間同期

3. **適応的なノイズモデル**：
   - 加速度の大きさに基づく適応的なノイズパラメータ
   - 機動時の磁力計信頼性低減

4. **故障検出と対応**：
   - イノベーションの一貫性チェック
   - センサの異常値検出と排除

## パフォーマンス考慮事項

1. **計算効率**：
   - 行列演算の最適化
   - スパース性を利用した計算量削減

2. **メモリ使用**：
   - センサデータバッファリング
   - 状態履歴の保持

3. **ロバスト性**：
   - 複数のセンサ融合戦略
   - 補完的なフィルタリング手法

## まとめ

ArduPilotは複数の拡張カルマンフィルタ実装を提供し、様々な飛行シナリオと精度要件に対応している。主要な実装はEKF2とEKF3であり、複数のセンサからのデータを融合して、ロバストな姿勢、位置、速度の推定を行っている。

EKF2は100Hz (10ms)、EKF3は83.3Hz (12ms)の更新レートで動作する。IMUデータは高いレート（1kHz～8kHz）でサンプリングされ、適切な方法でダウンサンプリングされてEKFに供給される。10Hzの値はIMUデータに適用されるローパスフィルタのカットオフ周波数であり、これはハイパスフィルタではない。

IMUの積分のためのサンプリング時間は、直接測定され、異常値からの保護とフィルタリングが行われ、四元数計算を用いてコーニングエラーを防止している。これにより、高精度な姿勢と位置の推定が可能になっている。 