# M5StampFly カルマンフィルタ実装調査

このドキュメントでは、M5StampFlyハードウェアでのArduPilotカルマンフィルタ実装について調査結果をまとめています。

## M5StampFlyハードウェア概要

M5StampFlyは[M5Stack](https://shop.m5stack.com/products/m5stamp-fly-with-m5stamps3)が提供するESP32-S3ベースの小型フライトコントローラーです。ArduPilotファームウェアに対応しており、以下の主要なセンサーを搭載しています：

| センサー | タイプ | 接続方式 | 備考 |
|---------|-------|----------|------|
| IMU | BMI270 | SPI | 姿勢・加速度検出用、`ROTATION_ROLL_180_YAW_90`で実装 |
| 気圧計 | BMP280 | I2C (アドレス: 0x76) | 高度検出用 |
| コンパス | - | - | デフォルトで無効化 (`AP_COMPASS_ENABLE_DEFAULT 0`) |
| バッテリーモニタ | INA3221 | I2C | バッテリー電圧・電流測定用 |

対気速度センサーは未サポート (`AP_AIRSPEED_ENABLED 0`) となっています。

## カルマンフィルタの実装

M5StampFlyに固有のカルマンフィルタ実装は存在しません。代わりに、ArduPilotの標準的な拡張カルマンフィルタ（EKF）実装を使用します。具体的には以下の実装が使われます：

1. **EKF3** - ArduPilotの主要なナビゲーションフィルタ (AP_NavEKF3ライブラリ)
2. **EKFGSF** - 方位角（ヨー）推定のための補助フィルタ

### センサー入力

M5StampFlyでは、カルマンフィルタに以下のセンサー入力が提供されます：

- **BMI270 IMU**: 角速度と加速度データを提供
- **BMP280 気圧計**: 高度データを提供

コンパスはデフォルトで無効化されているため、通常のEKF実装ではGPS速度ベースのヨー推定（EKFGSF）が重要になります。

### フィルタの設定

M5StampFlyのデフォルトパラメータファイル（`defaults.parm`）には、以下のフィルタ関連の設定が含まれています：

```
INS_GYRO_FILTER 134        # ジャイロフィルタカットオフ周波数 (134Hz)
SCHED_LOOP_RATE 150        # メインループレート (150Hz)
```

また、姿勢制御のためのフィルタ設定も含まれています：

```
ATC_RAT_PIT_FLTD 67        # ピッチレート D項フィルタ (67Hz)
ATC_RAT_PIT_FLTT 67        # ピッチレート 微分項フィルタ (67Hz)
ATC_RAT_RLL_FLTD 67        # ロールレート D項フィルタ (67Hz)
ATC_RAT_RLL_FLTT 67        # ロールレート 微分項フィルタ (67Hz)
ATC_RAT_YAW_FLTD 0         # ヨーレート D項フィルタ (無効)
ATC_RAT_YAW_FLTE 2         # ヨーレート E項フィルタ (2Hz)
ATC_RAT_YAW_FLTT 67        # ヨーレート 微分項フィルタ (67Hz)
```

### 姿勢制御フィルタの詳細解説

ArduPilotの姿勢制御システムでは、様々なフィルタを使用して制御信号の品質を向上させています。M5StampFlyで使用されている姿勢制御フィルタの設定について、それぞれの意味と役割を解説します。

#### フィルタパラメータの基本概念

ArduPilotの姿勢制御フィルタパラメータは以下のような命名規則になっています：
- `ATC_RAT_XXX_FLTY`: XXXは軸（PIT=ピッチ、RLL=ロール、YAW=ヨー）、Yはフィルタの種類

#### 各フィルタパラメータの詳細

##### ピッチ軸フィルタ

`ATC_RAT_PIT_FLTD 67` (ピッチレート D項フィルタ)
- **意味**: ピッチレートのPID制御におけるD項（微分項）に適用されるローパスフィルタのカットオフ周波数
- **役割**: 高周波ノイズを抑制しつつ、D項の微分動作による制御の安定性を維持
- **値の影響**: 
  - 高い値（67Hz）: 応答性が高く、素早い動きに追従可能だが、ノイズの影響を受けやすい
  - 低い値: ノイズ耐性は向上するが、応答性が低下し、素早い動きへの追従が困難になる

`ATC_RAT_PIT_FLTT 67` (ピッチレート 微分項フィルタ)
- **意味**: ピッチレートのPID制御に入力される角速度信号自体に適用されるローパスフィルタ
- **役割**: PID制御に入力される前の角速度信号のノイズを除去
- **値の意義**: 微分項フィルタとD項フィルタを同じ周波数（67Hz）に設定することで、フィルタリングの整合性を保ち、位相遅延を最小化

##### ロール軸フィルタ

`ATC_RAT_RLL_FLTD 67` および `ATC_RAT_RLL_FLTT 67`
- ピッチ軸と同様の役割で、ロール軸の制御に適用
- 67Hzという値は、BMI270 IMUのサンプリングレートと処理能力を考慮して選択されており、ESP32-S3の処理能力と小型機の応答特性のバランスを取っている

##### ヨー軸フィルタ

`ATC_RAT_YAW_FLTD 0` (ヨーレート D項フィルタ)
- **意味**: ヨーレートのD項フィルタが無効（0Hz）
- **特別な理由**: ヨー軸は他の軸と比較して動きが遅く、D項による微分制御がなくても安定する傾向があるため、M5StampFlyではD項フィルタを無効化して計算負荷を軽減

`ATC_RAT_YAW_FLTE 2` (ヨーレート E項フィルタ)
- **意味**: ヨーレートのPID制御における誤差項に適用されるローパスフィルタ
- **特徴**: 非常に低い周波数（2Hz）に設定されており、ヨー軸の動きをゆっくりと安定化
- **目的**: 急激なヨー軸の制御入力を抑え、滑らかな旋回動作を実現

`ATC_RAT_YAW_FLTT 67` (ヨーレート 微分項フィルタ)
- ピッチ・ロールと同じ周波数だが、ヨー軸では異なる役割
- **特別な役割**: D項が無効の状態でも、基本的な角速度信号のフィルタリングを行い、PID制御の入力信号品質を確保

#### 値の選定理由と影響

##### 67Hzが選ばれた理由

1. **ハードウェアの限界との関係**:
   - M5StampFlyのメインループレートは150Hz（`SCHED_LOOP_RATE 150`）
   - ナイキスト定理によれば、フィルタのカットオフ周波数はサンプリングレートの半分未満が理想的
   - 150Hz÷2 = 75Hzであり、67Hzはこれより少し低い値で安全マージンを確保

2. **IMUフィルタとの関係**:
   - IMUのジャイロフィルタは134Hz（`INS_GYRO_FILTER 134`）に設定されており、姿勢制御フィルタはこれより低い周波数に設定するのが一般的
   - 67Hz ≈ 134Hz÷2 となっており、IMUフィルタとの整合性を保っている

##### フライト特性への影響

- **応答性とノイズ耐性のバランス**:
  - 67Hzという比較的高いフィルタ値により、小型ドローンの俊敏な操縦性を維持しつつ、適度なノイズ抑制を実現
  - ヨー軸のD項フィルタを無効化し、E項フィルタを2Hzと低く設定することで、ESP32-S3の限られた処理能力を効率的に活用
  - この組み合わせにより、M5StampFlyは小型の室内用ドローンとして適切な応答性と安定性を実現

##### 実用上の意義

- **小型機向け最適化**:
  - これらの設定値は特にM5StampFlyのような小型・軽量の機体向けに最適化されている
  - 限られたセンサー構成（コンパス非搭載）と処理能力の制約の中で最大のパフォーマンスを引き出すための設定

- **調整の余地**:
  - ユーザーの飛行スタイルや追加センサーの接続状況によっては、これらの値をカスタマイズすることも可能
  - 特に屋外での飛行や風の影響が大きい環境では、フィルタ値を調整することで安定性を向上できる可能性がある

### カルマンフィルタの動作

M5StampFlyでのEKFの動作は、ArduPilotの標準実装と同じです：

1. **初期化**：
   - BMI270 IMUからのデータを使用して姿勢を初期化
   - 共分散行列の初期設定

2. **予測ステップ**：
   - IMUデータを使用して状態を予測
   - 主にBMI270からの角速度と加速度データを使用

3. **更新ステップ**：
   - BMP280気圧計からの高度データで更新
   - GPSが接続されている場合はGPSデータも使用
   - コンパスは無効なため、EKFGSF（GPSベースのヨー推定）が重要

### 制約事項

M5StampFlyのハードウェア構成による制約事項：

1. **ヨー推定の精度**：
   - コンパスがないため、ヨー推定はGPS速度に依存
   - 静止状態や低速移動時にヨー推定精度が低下する可能性

2. **処理能力**：
   - ESP32-S3の処理能力により、EKFの更新レートが制限される
   - `SCHED_LOOP_RATE 150`の設定コメントに「flash won't go faster :(」と記載

3. **利用可能なセンサー**：
   - 対気速度センサーがないため、風速推定は限定的
   - 外部GPSが必要なナビゲーション機能

## まとめ

M5StampFlyは、ArduPilotの標準EKF実装を使用してセンサーフュージョンと状態推定を行います。専用のカルマンフィルタ実装は持たず、既存のArduPilot EKFフレームワーク内でBMI270 IMUとBMP280気圧計のデータを処理します。

標準的なEKF実装について詳しくは、ArduPilotのEKF2/EKF3実装を参照してください。これらは複数のセンサー入力を処理し、ロバストな姿勢推定と位置推定を提供します。M5StampFlyの限られたセンサー構成でも、基本的なフライト制御と安定化に十分な性能を発揮します。 